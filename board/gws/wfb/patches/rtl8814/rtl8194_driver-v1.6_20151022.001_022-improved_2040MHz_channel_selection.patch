From 566ccb1c6ceba0b8a8b41046ab8e288d6224d53a Mon Sep 17 00:00:00 2001
From: Allan Dickow <allan.dickow@greenwavesystems.com>
Date: Fri, 18 Mar 2016 13:36:17 +0100
Subject: [PATCH 1/3] ref: improved 2040 channel selection

---
 driver/rtl8192cd/8192cd_cfg.h   |  1 +
 driver/rtl8192cd/8192cd_osdep.c |  6 +++++
 driver/rtl8192cd/8192cd_sme.c   | 50 +++++++++++++++++++++++++++++++++++++++++
 3 files changed, 57 insertions(+)
 mode change 100755 => 100644 driver/rtl8192cd/8192cd_osdep.c
 mode change 100755 => 100644 driver/rtl8192cd/8192cd_sme.c

diff --git a/driver/rtl8192cd/8192cd_cfg.h b/driver/rtl8192cd/8192cd_cfg.h
index 8df8ed6..e3adb46 100644
--- a/driver/rtl8192cd/8192cd_cfg.h
+++ b/driver/rtl8192cd/8192cd_cfg.h
@@ -989,6 +989,7 @@
 #define WIFI_11N_2040_COEXIST
 #define WIFI_11N_2040_COEXIST_EXT
 //#define WIFI_11N_2040_PERMIT_LOGIC
+#define WIFI_11N_2040_CHANNEL_SELECTION
 //-------------------------------------------------------------
 // Add TX power by command
 //-------------------------------------------------------------
diff --git a/driver/rtl8192cd/8192cd_osdep.c b/driver/rtl8192cd/8192cd_osdep.c
old mode 100755
new mode 100644
index ceb89e8..fa4fc14
--- a/driver/rtl8192cd/8192cd_osdep.c
+++ b/driver/rtl8192cd/8192cd_osdep.c
@@ -7731,6 +7731,12 @@ priv->drv_state |= DRV_STATE_OPEN;      // set driver as has been opened, david
 #ifdef MBSSID
 	if (IS_ROOT_INTERFACE(priv))
 #endif
+#ifdef WIFI_11N_2040_CHANNEL_SELECTION
+	if (priv->pmib->dot11RFEntry.phyBandSelect & PHY_BAND_2G && priv->pshare->is_40m_bw == HT_CHANNEL_WIDTH_20_40) {
+		priv->ss_ssidlen = 0;
+		start_clnt_ss(priv);
+	} else
+#endif
 	if ((OPMODE & WIFI_AP_STATE) && priv->auto_channel) {
 		if (((priv->pmib->dot1180211AuthEntry.dot11PrivacyAlgrthm != _TKIP_PRIVACY_) &&
 			  (priv->pmib->dot1180211AuthEntry.dot11PrivacyAlgrthm != _CCMP_PRIVACY_) &&
diff --git a/driver/rtl8192cd/8192cd_sme.c b/driver/rtl8192cd/8192cd_sme.c
old mode 100755
new mode 100644
index 9f39e47..2b33be5
--- a/driver/rtl8192cd/8192cd_sme.c
+++ b/driver/rtl8192cd/8192cd_sme.c
@@ -14015,6 +14015,9 @@ void rtl8192cd_ss_timer(unsigned long task_priv)
 #if defined(CONFIG_P2P_RTK_SUPPORT) && defined(RTK_NL80211)
     u8 tx_pause_val;
 #endif
+#ifdef WIFI_11N_2040_CHANNEL_SELECTION
+	int scanChannelLow=0, scanChannelHigh=0;
+#endif
 	if (!(priv->drv_state & DRV_STATE_OPEN))
 		return;
 
@@ -14586,6 +14589,32 @@ abort_scan:
             
     		debug_print_bss(priv);            
 
+#ifdef WIFI_11N_2040_CHANNEL_SELECTION
+			if (priv->auto_channel == 0) {
+				if (priv->pmib->dot11RFEntry.phyBandSelect & PHY_BAND_2G && priv->pshare->is_40m_bw == HT_CHANNEL_WIDTH_20_40){
+					if (priv->pshare->offset_2nd_chan == HT_2NDCH_OFFSET_ABOVE) {
+						scanChannelLow = ((priv->pmib->dot11RFEntry.dot11channel+2-5)>0)?(priv->pmib->dot11RFEntry.dot11channel+2-5):1;
+						scanChannelHigh = ((priv->pmib->dot11RFEntry.dot11channel+2+5)>13)?13:(priv->pmib->dot11RFEntry.dot11channel+2+5);
+					} else {
+						scanChannelLow = ((priv->pmib->dot11RFEntry.dot11channel-2-5)>0)?(priv->pmib->dot11RFEntry.dot11channel-2-5):1;
+						scanChannelHigh = ((priv->pmib->dot11RFEntry.dot11channel-2+5)>13)?13:(priv->pmib->dot11RFEntry.dot11channel-2+5);
+					}
+
+					for(i=0; i<priv->site_survey->count; i++) {
+						if ((priv->site_survey->bss[i].channel >= scanChannelLow) && (priv->site_survey->bss[i].channel <= scanChannelHigh)) {
+							priv->pshare->is_40m_bw = HT_CHANNEL_WIDTH_20;
+							break;		
+						}
+					}
+
+					priv->pshare->CurrentChannelBW = priv->pshare->is_40m_bw;
+					SwBWMode(priv, priv->pshare->CurrentChannelBW, priv->pshare->offset_2nd_chan);
+					SwChnl(priv, priv->pmib->dot11RFEntry.dot11channel, priv->pshare->offset_2nd_chan);
+				}
+			}
+#endif
+
+
 #ifdef RTK_NL80211  //nl_clnt
 			SMP_UNLOCK(flags);
 			NDEBUG2("end of scan,==>realtek_cfg80211_inform_ss_result\n");
@@ -14690,6 +14719,27 @@ abort_scan:
 				else
 					priv->auto_channel = 2;
 
+#ifdef WIFI_11N_2040_CHANNEL_SELECTION
+			if (priv->auto_channel == 0) {
+				if (priv->pmib->dot11RFEntry.phyBandSelect & PHY_BAND_2G && priv->pshare->is_40m_bw == HT_CHANNEL_WIDTH_20_40){
+					if (priv->pshare->offset_2nd_chan == HT_2NDCH_OFFSET_ABOVE) {
+						scanChannelLow = ((priv->pmib->dot11RFEntry.dot11channel+2-5)>0)?(priv->pmib->dot11RFEntry.dot11channel+2-5):1;
+						scanChannelHigh = ((priv->pmib->dot11RFEntry.dot11channel+2+5)>13)?13:(priv->pmib->dot11RFEntry.dot11channel+2+5);
+					} else {
+						scanChannelLow = ((priv->pmib->dot11RFEntry.dot11channel-2-5)>0)?(priv->pmib->dot11RFEntry.dot11channel-2-5):1;
+						scanChannelHigh = ((priv->pmib->dot11RFEntry.dot11channel-2+5)>13)?13:(priv->pmib->dot11RFEntry.dot11channel-2+5);
+					}
+
+					for(i=0; i<priv->site_survey->count; i++) {
+						if ((priv->site_survey->bss[i].channel >= scanChannelLow) && (priv->site_survey->bss[i].channel <= scanChannelHigh)) {
+							priv->pshare->is_40m_bw = HT_CHANNEL_WIDTH_20;
+							break;		
+						}
+					}
+				}
+			}
+#endif
+
 				priv->pshare->CurrentChannelBW = priv->pshare->is_40m_bw;
 #if defined(CONFIG_RTL_SIMPLE_CONFIG)
 				if(!rtk_sc_is_channel_fixed(priv))
-- 
1.9.1

